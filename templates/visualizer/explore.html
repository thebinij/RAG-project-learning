{% extends "base.html" %}

{% block title %}Data Explorer - ChromaDB Visualizer{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .explore-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .embedding-viz {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    .metadata-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .analysis-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4 text-center mb-3">
                    <i class="fas fa-compass text-primary me-3"></i>
                    Data Explorer
                </h1>
                <p class="lead text-center text-muted">
                    Deep dive into your ChromaDB data with advanced analytics and visualizations
                </p>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <i class="fas fa-cubes fa-2x mb-2"></i>
                    <h3 id="totalChunks">-</h3>
                    <p class="mb-0">Total Chunks</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <i class="fas fa-folder fa-2x mb-2"></i>
                    <h3 id="totalCategories">-</h3>
                    <p class="mb-0">Categories</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <i class="fas fa-file fa-2x mb-2"></i>
                    <h3 id="totalFiles">-</h3>
                    <p class="mb-0">Files</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <i class="fas fa-ruler-horizontal fa-2x mb-2"></i>
                    <h3 id="avgChunkSize">-</h3>
                    <p class="mb-0">Avg Chunk Size</p>
                </div>
            </div>
        </div>

        <!-- Category Analysis -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-chart-pie me-2 text-primary"></i>
                Category Distribution Analysis
            </h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="categoryBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Analysis -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-chart-bar me-2 text-primary"></i>
                File Distribution Analysis
            </h4>
            <div class="chart-container">
                <canvas id="fileDistributionChart"></canvas>
            </div>
        </div>

        <!-- Chunk Size Analysis -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-ruler-combined me-2 text-primary"></i>
                Chunk Size Distribution
            </h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="chunkSizeHistogram"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="analysis-section">
                        <h6>Size Statistics</h6>
                        <div id="sizeStats">
                            <!-- Size statistics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata Analysis -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-tags me-2 text-primary"></i>
                Metadata Analysis
            </h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="analysis-section">
                        <h6>Metadata Keys</h6>
                        <div id="metadataKeys">
                            <!-- Metadata keys will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="analysis-section">
                        <h6>Category Breakdown</h6>
                        <div id="categoryBreakdown">
                            <!-- Category breakdown will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Embedding Visualization -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-project-diagram me-2 text-primary"></i>
                Embedding Space Visualization
            </h4>
            <div class="embedding-viz">
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    This visualization shows a 2D projection of document embeddings, grouped by category.
                    Documents with similar content will appear closer together.
                </p>
                <div class="chart-container">
                    <canvas id="embeddingChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Quality Analysis -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-shield-alt me-2 text-primary"></i>
                Data Quality Analysis
            </h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="analysis-section">
                        <h6>Completeness Check</h6>
                        <div id="completenessCheck">
                            <!-- Completeness check will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="analysis-section">
                        <h6>Consistency Check</h6>
                        <div id="consistencyCheck">
                            <!-- Consistency check will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="explore-card">
            <h4 class="mb-3">
                <i class="fas fa-download me-2 text-primary"></i>
                Export & Analysis
            </h4>
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="exportMetadata()">
                        <i class="fas fa-file-export me-2"></i>Export Metadata
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportStatistics()">
                        <i class="fas fa-chart-line me-2"></i>Export Statistics
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-info w-100 mb-2" onclick="generateReport()">
                        <i class="fas fa-file-alt me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
        let charts = {};

        // Load explore data
        document.addEventListener('DOMContentLoaded', function() {
            loadExploreData();
        });

        // Load all explore data
        async function loadExploreData() {
            try {
                const response = await fetch('/api/visualizer/stats');
                const stats = await response.json();
                
                if (stats.error) {
                    console.error('Error loading stats:', stats.error);
                    return;
                }
                
                updateMetrics(stats);
                createCharts(stats);
                populateAnalysis(stats);
                
            } catch (error) {
                console.error('Error loading explore data:', error);
            }
        }

        // Update metrics
        function updateMetrics(stats) {
            document.getElementById('totalChunks').textContent = stats.total_chunks;
            document.getElementById('totalCategories').textContent = Object.keys(stats.categories).length;
            document.getElementById('totalFiles').textContent = Object.keys(stats.files).length;
            document.getElementById('avgChunkSize').textContent = stats.avg_chunk_size + ' chars';
        }

        // Create all charts
        function createCharts(stats) {
            createCategoryPieChart(stats);
            createCategoryBarChart(stats);
            createFileDistributionChart(stats);
            createChunkSizeHistogram(stats);
            createEmbeddingChart(stats);
        }

        // Category pie chart
        function createCategoryPieChart(stats) {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            charts.categoryPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.categories),
                    datasets: [{
                        data: Object.values(stats.categories),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Category Distribution'
                        }
                    }
                }
            });
        }

        // Category bar chart
        function createCategoryBarChart(stats) {
            const ctx = document.getElementById('categoryBarChart').getContext('2d');
            charts.categoryBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.categories),
                    datasets: [{
                        label: 'Chunks',
                        data: Object.values(stats.categories),
                        backgroundColor: '#667eea',
                        borderColor: '#5a6fd8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Chunks per Category'
                        }
                    }
                }
            });
        }

        // File distribution chart
        function createFileDistributionChart(stats) {
            const sortedFiles = Object.entries(stats.files).sort((a, b) => b[1] - a[1]).slice(0, 15);
            
            const ctx = document.getElementById('fileDistributionChart').getContext('2d');
            charts.fileDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedFiles.map(([file, _]) => file),
                    datasets: [{
                        label: 'Chunks',
                        data: sortedFiles.map(([_, count]) => count),
                        backgroundColor: '#28a745',
                        borderColor: '#20c997',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 15 Files by Chunk Count'
                        }
                    }
                }
            });
        }

        // Chunk size histogram
        function createChunkSizeHistogram(stats) {
            // Simulate chunk size distribution (in real scenario, you'd get this from the data)
            const sizeRanges = ['0-100', '101-200', '201-300', '301-400', '401-500', '500+'];
            const sizeCounts = [10, 25, 35, 20, 8, 2]; // Example distribution
            
            const ctx = document.getElementById('chunkSizeHistogram').getContext('2d');
            charts.chunkSizeHistogram = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sizeRanges,
                    datasets: [{
                        label: 'Chunks',
                        data: sizeCounts,
                        backgroundColor: '#ffc107',
                        borderColor: '#e0a800',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Chunk Size Distribution (characters)'
                        }
                    }
                }
            });
        }

        // Embedding visualization
        function createEmbeddingChart(stats) {
            const ctx = document.getElementById('embeddingChart').getContext('2d');
            
            // Simulate embedding data (in real scenario, you'd get this from the embeddings)
            const categories = Object.keys(stats.categories);
            const data = [];
            
            categories.forEach((category, catIndex) => {
                const count = stats.categories[category];
                for (let i = 0; i < Math.min(count, 20); i++) { // Limit to 20 points per category
                    data.push({
                        x: Math.random() * 100,
                        y: Math.random() * 100,
                        category: category
                    });
                }
            });
            
            charts.embedding = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: categories.map((category, index) => ({
                        label: category,
                        data: data.filter(d => d.category === category).map(d => ({x: d.x, y: d.y})),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ][index % 8],
                        pointRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Embedding Dimension 1'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Embedding Dimension 2'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Document Embeddings (2D Projection)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Populate analysis sections
        function populateAnalysis(stats) {
            populateSizeStats(stats);
            populateMetadataKeys(stats);
            populateCategoryBreakdown(stats);
            populateQualityChecks(stats);
        }

        // Size statistics
        function populateSizeStats(stats) {
            const container = document.getElementById('sizeStats');
            container.innerHTML = `
                <div class="mb-2">
                    <strong>Average:</strong> ${stats.avg_chunk_size} characters
                </div>
                <div class="mb-2">
                    <strong>Total:</strong> ${(stats.avg_chunk_size * stats.total_chunks).toLocaleString()} characters
                </div>
                <div class="mb-2">
                    <strong>Range:</strong> Estimated 50-800 characters
                </div>
            `;
        }

        // Metadata keys
        function populateMetadataKeys(stats) {
            const container = document.getElementById('metadataKeys');
            container.innerHTML = `
                <div class="mb-2">
                    <strong>Total Keys:</strong> ${stats.metadata_keys.length}
                </div>
                <div class="mb-2">
                    <strong>Keys:</strong>
                </div>
                <div class="small">
                    ${stats.metadata_keys.map(key => 
                        `<span class="badge bg-light text-dark me-1">${key}</span>`
                    ).join('')}
                </div>
            `;
        }

        // Category breakdown
        function populateCategoryBreakdown(stats) {
            const container = document.getElementById('categoryBreakdown');
            const total = stats.total_chunks;
            
            let html = '';
            Object.entries(stats.categories).forEach(([category, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${category}</span>
                            <span>${count} (${percentage}%)</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Quality checks
        function populateQualityChecks(stats) {
            // Completeness check
            const completenessContainer = document.getElementById('completenessCheck');
            const hasTitle = stats.metadata_keys.includes('title');
            const hasCategory = stats.metadata_keys.includes('category');
            const hasFile = stats.metadata_keys.includes('file');
            
            completenessContainer.innerHTML = `
                <div class="mb-2">
                    <i class="fas fa-${hasTitle ? 'check text-success' : 'times text-danger'} me-2"></i>
                    Title field: ${hasTitle ? 'Present' : 'Missing'}
                </div>
                <div class="mb-2">
                    <i class="fas fa-${hasCategory ? 'check text-success' : 'times text-danger'} me-2"></i>
                    Category field: ${hasCategory ? 'Present' : 'Missing'}
                </div>
                <div class="mb-2">
                    <i class="fas fa-${hasFile ? 'check text-success' : 'times text-danger'} me-2"></i>
                    File field: ${hasFile ? 'Present' : 'Missing'}
                </div>
            `;
            
            // Consistency check
            const consistencyContainer = document.getElementById('consistencyCheck');
            const categoryCount = Object.keys(stats.categories).length;
            const fileCount = Object.keys(stats.files).length;
            
            consistencyContainer.innerHTML = `
                <div class="mb-2">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Categories: ${categoryCount}
                </div>
                <div class="mb-2">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Files: ${fileCount}
                </div>
                <div class="mb-2">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Avg chunks per file: ${(stats.total_chunks / fileCount).toFixed(1)}
                </div>
            `;
        }

        // Export functions
        function exportMetadata() {
            // This would export metadata to JSON
            alert('Metadata export functionality would be implemented here');
        }

        function exportStatistics() {
            // This would export statistics to CSV/JSON
            alert('Statistics export functionality would be implemented here');
        }

        function generateReport() {
            // This would generate a comprehensive report
            alert('Report generation functionality would be implemented here');
        }
    </script>
{% endblock %}
